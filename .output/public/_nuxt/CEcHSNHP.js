var G=Object.defineProperty;var W=(n,e,t)=>e in n?G(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var a=(n,e,t)=>W(n,typeof e!="symbol"?e+"":e,t);import{_ as j}from"./DZ1mGyOo.js";import{r as v,p as U,u as _,v as N,x as J,g as P,h as O,c as $,b as q,z as X,w as Y,T as Z,A as c,m as h,n as m,an as K,o as H,I as Q,L as ee,a as te,P as ne,ao as V,U as se,_ as oe}from"./BPB8L8dL.js";import{s as ie}from"./BGaU4wP5.js";const ae=512;function re(){return new Promise((n,e)=>{try{window.AudioContext=window.AudioContext??window.webkitAudioContext,n(new window.AudioContext)}catch(t){console.info("Web Audio API is not supported.",t),e(t)}})}function le(n){const e=n.createAnalyser();return e.smoothingTimeConstant=.6,e.fftSize=ae,e}function ue(n){return new Uint8Array(n.frequencyBinCount)}function ce(n,e,t,s=()=>{}){const o=e.createBufferSource();return o.loop=t,o.connect(n),o.connect(e.destination),o.onended=function(){s()},o}function de(n){return new Promise((e,t)=>{let s=new XMLHttpRequest;s.open("GET",n,!0),s.responseType="arraybuffer",s.onload=function(){e(s.response)},s.send()})}function he(n,e,t,s){return new Promise((o,i)=>{try{n.decodeAudioData(e,t,s),o()}catch(u){console.error(u),console.warn("Error loading sound."),i(u)}})}function fe(n,e,t){if(n){if(n.state==="suspended")return{"last-state":n.state,ret:n.resume()};e.buffer=t,e.start(0)}}function pe(n){n.suspend()}function me(n,e){e.disconnect(),n.close().catch(t=>{console.error(t),console.warn("Error closing sound.")})}function ve(n,e,t,s,o,i="center"){const u=n.createLinearGradient(0,0,0,300);return u.addColorStop(1,e),n.fillStyle=u,n.shadowBlur=t,n.shadowColor=s,n.font=o,n.textAlign=i,u}function ge(n,e,t,s,o=40,i="Music OFF",u="bold"){n.font=`${u} ${o}px ${s}`,n.fillText(i,e,t)}function ye(n,e,t,s,o,i,u,d="bold"){const g=e.width/2,f=e.height/2,y=o;n.font=`${d} ${u}px ${i}`,n.textBaseline="top",n.fillText(`by ${s}`,g+y,f),n.font=`${d} ${u}px ${i}`,n.textBaseline="bottom",n.fillText(t,g+y,f)}function Se(n,e,t,s,o,i){let u=`${t}:${s}`;n.fillText(u,e.width/2+o,e.height/2+i)}function we(n,e,t,s,o,i,u){const d=e.width/2,g=e.height/2,f=Math.floor(t*2*Math.PI/(s+i)),y=Math.floor(f*25/100),C=f-y,T=Math.floor(u.length/f);for(let S=0;S<C;S++){const w=u[S*T],x=S*2*Math.PI/f,b=(3*45-s)*Math.PI/180,k=0,I=t-(w/12-o),A=s,B=w/6+o;n.save(),n.translate(d+i,g+i),n.rotate(x-b),n.fillRect(k,I,A,B),n.restore()}}let M,F=[];const Ce={lounge:"renderLounge"};class z{constructor(e){a(this,"isPlaying");a(this,"loading");a(this,"loaded");a(this,"disposed");a(this,"state","not-initialized");a(this,"analyser");a(this,"sourceNode");a(this,"canvasCtx");a(this,"audioContext");a(this,"frequencyData");a(this,"duration");a(this,"minutes");a(this,"seconds");a(this,"gradient");a(this,"autoplay");a(this,"loop");a(this,"canvas");a(this,"title");a(this,"author");a(this,"audioSrc");a(this,"style");a(this,"barWidth");a(this,"barHeight");a(this,"barSpacing");a(this,"barColor");a(this,"shadowBlur");a(this,"shadowColor");a(this,"font");a(this,"fontSize");a(this,"_onClick");a(this,"clickHandler");a(this,"onMusicEnded");a(this,"fetchBufferSrc");this.isPlaying=!1,this.autoplay=e.autoplay||!1,this.loop=e.loop.value!==void 0?e.loop:e.loop.value===void 0&&e.loop||v(!1),this.canvas=document.getElementById(e.canvas),this.canvasCtx=this.canvas.getContext("2d"),this.author=e.author||"",this.title=e.title||"",this.audioContext=null,this.analyser=null,this.sourceNode=null,this.frequencyData=[],this.audioSrc=e.audioSrc||null,this.duration=0,this.minutes="00",this.seconds="00",this.style=e.style||"lounge",this.barWidth=e.barWidth||2,this.barHeight=e.barHeight||2,this.barSpacing=e.barSpacing||5,this.barColor=e.barColor||"#ffffff",this.shadowBlur=e.shadowBlur||10,this.shadowColor=e.shadowColor||"#ffffff",this.font=e.font||["12px","Helvetica"],this.fontSize=e.fontSize||12,this.gradient=null,this.clickHandler=e.clickHandler||null,this._onClick=null,this.loading=!1,this.loaded=!1,this.disposed=!1,this.onMusicEnded=e.onMusicEnded||null,this.fetchBufferSrc=e.fetchBufferSrc||null}playSound(e){const t=fe(this.audioContext,this.sourceNode,e);if(this.isPlaying=!0,this.state="playing",t!=null&&t.ret)return t.ret;this.resetTimer(),this.startTimer(),this.renderFrame()}pauseSound(){pe(this.audioContext),this.isPlaying=!1,this.state="paused"}startTimer(){var e=this;M=ie(function(){if(e.isPlaying){var t=new Date(e.duration),s=t.getHours(),o=t.getMinutes();e.minutes=s<10?"0"+s:s.toString(),e.seconds=o<10?"0"+o:o.toString(),e.duration=t.setMinutes(o+1)}},1e3)}resetTimer(){var e=new Date(0,0);this.duration=e.getTime()}onError(e){console.info("Error decoding audio file. --",e)}renderLounge(){const e=this.canvas;we(this.canvasCtx,e,140,this.barWidth,this.barHeight,this.barSpacing,this.frequencyData)}renderFrame(){if(this.cancelAnimationFrames(),F.push(requestAnimationFrame(this.renderFrame.bind(this))),!this.isPlaying)return;this.analyser.getByteFrequencyData(this.frequencyData);const e=this.canvas;this.canvasCtx.clearRect(0,0,e.width,e.height),Se(this.canvasCtx,e,this.minutes,this.seconds,10,80),ye(this.canvasCtx,e,this.title,this.author,10,this.font[1],this.fontSize),this.canvasCtx.font=this.font.join(" "),this.renderByStyleType().bind(this)()}renderByStyleType(){return this[Ce[this.style]]}cancelAnimationFrames(){for(;F.length>0;)cancelAnimationFrame(F.pop())}removeListeners(){this._onClick!==null&&document.documentElement.removeEventListener("click",this._onClick),this.cancelAnimationFrames()}bindEvents(){const e=this;this.removeListeners(),this._onClick=t=>{t.target===e.canvas&&(t.stopPropagation(),e.disposed||e.clickHandler(e.audioContext.state,t))},document.documentElement.addEventListener("click",this._onClick),e.autoplay&&this.loadSound()}loadSound(){if(!this.loading&&!this.loaded){this.loading=!0,this.state="loading";const e=this.canvas;ge(this.canvasCtx,e.width/2+10,e.height/2,this.font[1],this.fontSize);const t=o=>{this.loaded=!1,this.state="error",console.error(o),console.warn("Error loading sound.")},s=o=>{he(this.audioContext,o,this.playSound.bind(this),this.onError.bind(this)).then(()=>{this.loaded=!0,this.state="loaded"}).catch(i=>{t(i)})};this.fetchBufferSrc!==null?this.fetchBufferSrc(this.audioSrc||"").then(o=>{if(o===null)return t("buffer is null"),null;s(o)}):de(this.audioSrc).then(o=>{this.loading=!1,s(o)})}}initialize(){this.gradient=ve(this.canvasCtx,this.barColor,this.shadowBlur,this.shadowColor,this.font.join(" "))}dispose(){const e=this.canvas;this.canvasCtx.clearRect(0,0,e.width,e.height),clearInterval(M),this.removeListeners(),this.loaded&&(this.isPlaying=!1,this.resetTimer(),me(this.audioContext,this.sourceNode),this.audioContext=null,this.disposed=!0,this.state="disposed")}static _createVisualizer(e){const t=new z(e);return async function(){return t.audioContext=await re(),t.analyser=le(t.audioContext),t.frequencyData=ue(t.analyser),t.sourceNode=ce(t.analyser,t.audioContext,t.loop.value,()=>{var s;clearInterval(M),(s=t.sourceNode)==null||s.disconnect(),t.resetTimer(),t.isPlaying=!1,t.loop.value&&(t.sourceNode=t.audioContext.createBufferSource()),t.onMusicEnded()}),t.initialize(),t.bindEvents(),t}}static getInstance(e){return this._createVisualizer(e)()}}const be=["src","data-author","data-title","type"],Ee=U({__name:"Music",props:{musicFile:String,musicAuthor:String,musicTitle:String,musicType:{default:"audio/mp3",type:String},fgColor:{default:"#399db7",type:String},shadowColor:{default:"#000000eb",type:String},stopIcon:{default:"",type:String},rewindIcon:{default:"",type:String},font:{default:"Gotham Condensed Black",type:String},fontSize:{default:48,type:Number},musicLoop:{default:!0,type:Boolean},onMusicEnded:{default:()=>{},type:Function},fetchBufferSrc:null},emits:["onPlayState"],setup(n,{emit:e}){ne(r=>({acef40c4:c(g),"5efe69d2":c(f),f91ffd6e:c(w)}));const t=n,s=v("not-started"),o=e,i=v(),u=v(),d=_("musicSingleton",()=>!1),g=v(t.stopIcon.length>0?t.stopIcon:`url("${N("/assets/images/icons/stop.svg")}")`),f=v(t.rewindIcon.length>0?t.rewindIcon:'url("'+N("/assets/images/icons/rock.svg")+'")'),y=r=>{r.preventDefault(),c(s)==="playing"?(m("#canvas","bounce"),h("#canvas","active")):c(s)==="paused"&&(setTimeout(()=>{h("#canvas","bounce")},500),m("#canvas","active"),s.value="not-started",se(()=>s.value="paused")),h("#canvas","always-show")},C=(r=!0)=>{m(".pause-icon",["paused","closed"]),m("#canvas","paused");try{c(i).loaded||i.value.loadSound(),r&&c(d)&&i.value.playSound(null),s.value="playing"}catch(l){console.error(l),console.warn("Error playing sound"),s.value="error"}},T=async r=>{r.preventDefault();const l=document.getElementById("hero");if(!c(i)){d.value=!1,await b()&&(i.value.loadSound(),m(".pause-icon",["closed","paused"])),h(l,"foreground");return}if(c(s)==="playing"){if(!i.value.loaded||!i.value.isPlaying)return;if(i.value.pauseSound(),s.value="paused",l){const p=["hover","foreground"];(!V(l,p[0])||!V(l,p[1]))&&h(l,p)}h(".pause-icon","paused"),h("#canvas","paused")}else c(s)==="paused"?(i.value.dispose(),s.value="disposed",m(l,"foreground"),h(".pause-icon","closed"),i.value=null):c(s)},S=r=>{if(s.value=r==="running"?"playing":r==="suspended"?"paused":r==="closed"?"disposed":"not-started",c(s)!=="playing")if(c(s)==="paused"){const l=document.getElementById("hero");l&&m(l,["foreground"]),C()}else c(s)==="not-started"&&C()},w=v("612");_("music-top",()=>w.value);const x=()=>{setTimeout(()=>{w.value=_("music-top").value+"px"},300)},b=async()=>{if(t.musicFile.length>0&&!c(d)){const r={autoplay:!0,loop:K(t.musicLoop),title:t.musicTitle??"",author:t.musicAuthor??"",audioSrc:t.musicFile??"",canvas:"canvas",style:"lounge",barWidth:2,barHeight:2,barSpacing:7,barColor:t.fgColor,shadowBlur:5,shadowColor:t.shadowColor,font:["32px",t.font,""],fontSize:t.fontSize,clickHandler:S,onMusicEnded:t.onMusicEnded,fetchBufferSrc:t.fetchBufferSrc};return i.value=await z.getInstance(r),c(i)?(C(!1),d.value=!0,!!c(i)):!1}return d.value=!1,!1},k=r=>{var l;x(),c(d)||b(),(l=i.value)==null||l.initialize(),h(c(u),"activated")},I=r=>{if(r.target===u.value){r.stopPropagation();const l=document.getElementById("hero");l&&h(l,["hover"])}},A=r=>{if(r.target===u.value){r.stopPropagation();const l=document.getElementById("hero");l&&m(l,["hover"])}},B=()=>{x()},E=new AbortController;return J(()=>{var r,l,p;P(()=>t.musicFile,R=>{var L,D;(L=i.value)==null||L.pauseSound(),(D=i.value)==null||D.dispose(),d.value=!1,b(),s.value="not-started"}),P(()=>s.value,R=>{o("onPlayState",s.value)}),(r=document.querySelector(".app"))==null||r.addEventListener("onDockingStationAvailable",B,{signal:E.signal}),P(_("music-top"),()=>{B()},{immediate:!0}),document.documentElement.addEventListener("click",k,{signal:E.signal}),(l=u.value)==null||l.addEventListener("mouseenter",I,{signal:E.signal}),(p=u.value)==null||p.addEventListener("mouseleave",A,{signal:E.signal})}),O(()=>{var r;(r=i.value)==null||r.dispose(),d.value=!1,E.abort()}),(r,l)=>{const p=j;return H(),$("div",{class:"music",onClick:y},[q(p,{icon:"pause-icon",onClick:T}),t.musicFile.length>0?(H(),$("audio",{key:0,id:"audio",src:t.musicFile,"data-author":t.musicAuthor,"data-title":t.musicTitle,type:t.musicType},null,8,be)):X("",!0),q(Z,{name:"bounce"},{default:Y(()=>[Q(te("canvas",{id:"canvas",width:"340",height:"400",ref_key:"canvas",ref:u},null,512),[[ee,c(s)==="playing"||c(s)==="paused"]])]),_:1})])}}}),ke=oe(Ee,[["__scopeId","data-v-fd0e390d"]]);export{ke as default};
